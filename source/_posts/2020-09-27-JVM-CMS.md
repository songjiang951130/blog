---
title: HotSpot虚拟机垃圾收集调优指南（CMS篇）
categories:
  - jvm
tags:
  - thread
  - Linux
---

## 主要理念
### Concurrent Mark Sweep
CMS 设计目标是更少的垃圾回收暂停时间，能在应用运行时，进行垃圾回收。对象存活周期长（主要应用在老年代）和多核处理器（2020了，不会有线上cpu还单核吧）。期望应用更短暂停时间，应该采用这款垃圾回收器。JVM option 配置: `-XX:+UseConcMarkSweepGC` 与其他常见的回收器一样，CMS采用分代（minor 和 major）。
CMS由于单独的线程可以进行垃圾回收使得在major gc时同时可以进行对象访问，从而降低了GC时间。CMS在 major 时期，会在开始和中间产生暂停用户线程的访问。

## 暂停
CMS收集器在并发收集周期中两次暂停应用程序。第一个暂停是将可从根直接访问的对象（例如，来自应用程序线程堆栈和寄存器的对象引用，静态对象等）和从堆中其他位置（例如，年轻一代）直接标记为活动对象。第一暂停被称为`initial mark pause`。第二个暂停是在并发跟踪阶段的末尾，它查找由于CMS收集器完成了对象的引用后，应用程序线程对对象的引用进行了更新而导致并发跟踪遗漏的对象。第二暂停称为`remark pause`。


## 并发模式及其故障
CMS收集器在老年代（the tenured generation）使用多个垃圾收集器线程，这些垃圾收集器线程与应用程序线程同时运行。如前所述（暂停），在正常操作中，CMS收集器在应用程序线程仍在运行的情况下执行其大部分跟踪和清除工作，因此应用程序线程仅会看到短暂的暂停。但是，如果CMS收集器无法在老年代满前完成垃圾回收，或者老年代没有可用的空间进行新晋对象的空间分配，则暂停应用程序，并使用所有应用程序线程均已停止。这种情况称为并发模式故障，表示需要调整CMS收集器参数。如果并发收集被显式垃圾回收（System.gc()）中断，或者为提供诊断工具信息所需的垃圾收集中断了，这种情况称为并发中断。


## 配置参数
参数解释：
 - 以-X开头的选项是非标准的（不保证所有VM实施都支持该选项），并且在以后的JDK发行版中，如有更改，恕不另行通知。
 - 用-XX指定的选项不稳定，如有更改，恕不另行通知。


### 参考链接

[官方调优指导](https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/cms.html)
[大致流程梳理](https://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/index.html), 参见 review gc in cms
```
Young Generation 年轻代
Tenured Generation 老年代
Permanent Generation 永久代
```